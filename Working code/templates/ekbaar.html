<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Slide - Product Spec PPT</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(to bottom right, #FFA500, #ffffff); display: flex; justify-content: center; align-items: center; min-height: 100vh;}
        .container { background: white; padding: 32px 45px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.22); width: 470px; text-align: center;}
        h2 { color: #ff7300; margin-top:8px;}
        label { font-weight: bold; display: block; margin-top: 15px; margin-bottom: 7px; text-align: left;}
        input[type="text"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;}
        .button-row { display: flex; gap: 10px; justify-content: space-between; margin-top: 35px; }
        button { flex: 1 1 0; padding: 12px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s, color 0.2s;}
        .download-ready { background-color: #34b233 !important; color: #fff !important; }
        .download-disabled { background-color: #ccc !important; color: #666 !important; cursor: not-allowed !important;}
        button:not(.download-ready):not(.download-disabled) { background-color: #ff7300; color: white;}
        .secondary { background: #c7c7c7; color: #333;}
        button:hover:not(.download-disabled):not(.secondary):not(.download-ready) { background-color: #e66400;}
        button.download-ready:hover { background-color: #269d1c !important;}
        .warn {
            background: #ffefc9;
            border: 1.5px solid #ffa900;
            color: #c06a00;
            border-radius: 8px;
            padding: 13px 15px;
            margin: 16px 0 0 0;
            font-size: 15px;
            text-align: left;
        }
        /* Circle info button */
        .circle-help {
            position: absolute;
            right: 270px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 0;
            height: 22px;
            width: 22px;
            min-width: 22px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .circle-help svg {
            height: 22px;
            width: 22px;
        }
        #loader {
            display: none;
            margin-top: 10px;
        }
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff7300;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
    const templates = {{ templates_per_count|tojson }};
    let allowForceDownload = false;
    function updateTemplateOptions() {
        const count = document.getElementById('product_count').value;
        const templateSel = document.getElementById('template');
        templateSel.innerHTML = "";
        if (templates[count]) {
            for (let i = 1; i <= templates[count]; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = Template ${i};
                templateSel.appendChild(opt);
            }
            {% if slide_data %}
                templateSel.value = "{{ slide_data['template'] }}";
            {% endif %}
        }
    }
    function showProductInputs() {
        const n = parseInt(document.getElementById('product_count').value || 1);
        for (let i = 1; i <= 7; i++) {
            document.getElementById('code'+i).style.display = i <= n ? 'block':'none';
            document.getElementById('code_label'+i).style.display = i <= n ? 'block':'none';
        }
        checkRequired();
    }
    function checkRequired() {
        const n = parseInt(document.getElementById('product_count').value || 1);
        let ready = true;
        if (!document.querySelector('input[name="page_title"]').value.trim()) ready = false;
        for (let i = 1; i <= n; i++) {
            if (!document.getElementById('code'+i).value.trim()) ready = false;
        }
        if (!document.getElementById('template').value) ready = false;
        const finishBtn = document.getElementById('finishBtn');
        if (ready) {
            finishBtn.classList.remove('download-disabled');
            finishBtn.classList.add('download-ready');
            finishBtn.disabled = false;
        } else {
            finishBtn.classList.remove('download-ready');
            finishBtn.classList.add('download-disabled');
            finishBtn.disabled = true;
        }
    }
    window.onload = function() {
        updateTemplateOptions();
        showProductInputs();
        document.getElementById('product_count').onchange = function() {
            updateTemplateOptions();
            showProductInputs();
        }
        document.querySelector('input[name="page_title"]').oninput = checkRequired;
        document.getElementById('template').onchange = checkRequired;
        for (let i = 1; i <= 7; i++) {
            document.getElementById('code'+i).oninput = checkRequired;
        }
        checkRequired();
    }

    // --- Product validation (with backend) ---
    async function validateProducts(action) {
        document.getElementById('loader').style.display = 'block';

        if (action === 'validate') allowForceDownload = false;

        const n = parseInt(document.getElementById('product_count').value || 1);
        let codes = [];
        for (let i = 1; i <= n; i++) {
            let code = document.getElementById('code'+i).value.trim();
            if (code) codes.push(code);
        }
        if (codes.length === 0) {
            document.getElementById('loader').style.display = 'none';
            return true;
        }

        let res = await fetch("/validate_products", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codes: codes })
        });
        let data = await res.json();

        let missingWarnings = [];
        data.forEach(p => {
            if (!p.has_image) missingWarnings.push(ERP Code <b>${p.code}</b>: <span style="color:#e66400;">Missing Product Image</span>);
            if (!p.has_desc) missingWarnings.push(ERP Code <b>${p.code}</b>: <span style="color:#e66400;">Missing Description</span>);
        });

        // if (missingWarnings.length) {
        //     document.getElementById('warnBox').innerHTML =
        //         <strong>The following issues found:</strong><br> +
        //         missingWarnings.join("<br>") +
        //         <br><button type='button' onclick='forceSubmit("${action}")' style='margin-top:13px;padding:9px 24px;font-size:16px;border-radius:6px;background:#ff7300;color:#fff;border:none;cursor:pointer;'>Yes, Let Me Continue Anyway</button>;
        //     document.getElementById('warnBox').style.display = "block";
        //     document.getElementById('loader').style.display = 'none';
        //     window.scrollTo(0, document.body.scrollHeight);
        //     return false;
        // } else {
        //     document.getElementById('warnBox').style.display = "none";
        //     if (action === 'validate') {
        //         alert("✅ All products validated successfully!");
        //     }
        //     document.getElementById('loader').style.display = 'none';
        //     return true;
        // }
        const warnBox = document.getElementById('warnBox');
        if (missingWarnings.length) {
            warnBox.innerHTML =
                '<strong>The following issues found:</strong><br>' +
                missingWarnings.join("<br>") +
                '<br><span style="color:#66BB66;"><strong>You can still download using the \'Finish & Download\' button.</strong></span>';
            // <br><button type='button' onclick='forceSubmit("${action}")' style='margin-top:13px;padding:9px 24px;font-size:16px;border-radius:6px;background:#ff7300;color:#fff;border:none;cursor:pointer;'>Yes, Let Me Continue Anyway</button>;
            warnBox.style.background = '#ffefc9';
            warnBox.style.border = '1.5px solid #ffa900';
            warnBox.style.color = '#c06a00';
            warnBox.style.display = "block";
            document.getElementById('loader').style.display = 'none';
            window.scrollTo(0, document.body.scrollHeight);
            return false;
        } else {
            warnBox.innerHTML = '<strong>✅ All products validated successfully!</strong>';
            warnBox.style.background = '#e6ffe6';
            warnBox.style.border = '1.5px solid #1faa00';
            warnBox.style.color = '#207700';
            warnBox.style.display = "block";
            document.getElementById('loader').style.display = 'none';
            window.scrollTo(0, document.body.scrollHeight);
            return true;
        }
    }
    function forceSubmit(action) {
        let f = document.getElementById('slideForm');
        let h = document.createElement('input');
        h.type = "hidden";
        h.name = "action";
        h.value = "force_" + action;
        f.appendChild(h);
        f.submit();
    }
    </script>
</head>
<body>
<div class="container">
    <h2>Add Product Slide</h2>
    {% if total_slides %}
    <p style="font-size:14px;color:#888;margin:2px 0 14px 0;">Slide {{ slide_index+1 }} of {{ total_slides }}</p>
    {% endif %}
    <form id="slideForm" method="post" autocomplete="off">
        <label>Slide Title</label>
        <input type="text" name="page_title" required value="{{ slide_data['page_title'] if slide_data else '' }}">
        <label>Product Count</label>
        <select name="product_count" id="product_count" required>
            {% for i in range(1,8) %}
            <option value="{{i}}" {% if slide_data and slide_data['product_count'] == i %}selected{% endif %}>{{i}}</option>
            {% endfor %}
        </select>
        {% for i in range(1,8) %}
            <label id="code_label{{i}}">ERP Code #{{i}}</label>
            <input type="text" name="code{{i}}" id="code{{i}}" value="{% if slide_data and i <= slide_data['product_count'] %}{{ slide_data['codes'][i-1] if i-1 < slide_data['codes']|length else '' }}{% endif %}">
        {% endfor %}

        <!-- Template selection row with circle info button -->
        <label style="display:flex; align-items:center; position: relative;">
            Select Layout Template
            <button type="button" class="circle-help"
                onclick="window.open('{{ url_for('static', filename='template-info.pdf') }}', '_blank');"
                title="See all template layouts">
                <!-- onclick="window.open('{{ url_for('static', filename='template-info.docx') }}', '_blank');"
                title="See all template layouts"> -->
                <svg height="22" width="22">
                    <circle cx="11" cy="11" r="10" stroke="#ff7300" stroke-width="2" fill="#fff"/>
                    <text x="11" y="15" text-anchor="middle" font-size="15" fill="#ff7300" font-family="Arial" font-weight="bold">?</text>
                </svg>
            </button>
        </label>

        <select name="template" id="template" required>
            <!-- JS will fill -->
        </select>

        <div id="warnBox" class="warn" style="display:none"></div>
        <div id="loader"><div class="loader-spinner"></div></div>
        <div class="button-row">
            <button type="button" onclick="window.location.href='{{ url_for('index') }}'" class="secondary">Refresh</button> 
            <button type="submit" name="action" value="back" formnovalidate class="secondary">Back</button>
            
            <!-- Add Slide (no validation) -->
            <button type="submit" name="action" value="add_more" id="addMoreBtn">Add More Slide</button>

            <!-- Validate Button -->
            <button type="button" onclick="validateProducts('validate')" style="background-color:#fbbf24;color:#000;">Validate</button>

            <!-- Finish Button (with validation) -->
            <!-- <button type="submit" name="action" value="finish" id="finishBtn" class="download-disabled" disabled onclick="return validateProducts('finish');">Finish & Download</button> -->
            <button type="submit" name="action" value="finish" id="finishBtn" class="download-disabled" disabled>Finish & Download</button>

        </div>
    </form>
</div>
</body>
</html>
